<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate Media Finder</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .file-link {
            color: #0066cc;
            text-decoration: none;
            font-family: 'Courier New', monospace;
        }

        .file-link:hover {
            text-decoration: underline;
        }

        .duplicate-group {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-bottom: 20px;
        }

        .size-duplicate-group {
            border-left: 4px solid #ffc107;
            padding-left: 15px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .loading-spinner {
            display: none;
        }

        .file-path {
            font-size: 0.9em;
            color: #666;
            word-break: break-all;
        }

        .group-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h1 class="mb-4">
                    <i class="bi bi-images"></i>
                    Duplicate Media Finder
                </h1>

                <!-- Configuration Form -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-gear"></i>
                            Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="scanForm">
                            <div class="mb-3">
                                <label for="basePath" class="form-label">Remote Drive Path <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="basePath" name="base_path"
                                           placeholder="/path/to/remote/drive" required>
                                    <button type="button" class="btn btn-outline-secondary" id="testPathBtn">
                                        <i class="bi bi-check-circle"></i> Test Path
                                    </button>
                                </div>
                                <div class="form-text">Enter the root path to scan for duplicate files</div>
                                <div id="pathTestResult" class="mt-2"></div>
                            </div>

                            <div class="mb-3">
                                <label for="ignoredPaths" class="form-label">Paths to Ignore (Optional)</label>
                                <textarea class="form-control" id="ignoredPaths" name="ignored_paths" rows="4"
                                          placeholder="/path/to/ignore/1&#10;/path/to/ignore/2&#10;/path/to/ignore/3"></textarea>
                                <div class="form-text">Enter one path per line. These paths and their subdirectories will be excluded from scanning.</div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Supported File Types</label>
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        JPG, JPEG, PNG, MP4
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Minimum File Size</label>
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        100 KB (102,400 bytes)
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-search"></i>
                                Start Duplicate Scan
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="loading-spinner text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Scanning for duplicates... This may take a while for large directories.</p>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" style="display: none;">
                    <!-- Statistics -->
                    <div class="card stats-card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-bar-chart"></i>
                                Scan Statistics
                            </h5>
                            <div id="statsContent"></div>
                        </div>
                    </div>

                    <!-- Exact Duplicates -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-files"></i>
                                Exact Duplicates (Same Filename & Size)
                                <span id="exactDuplicatesCount" class="badge bg-danger ms-2">0</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="exactDuplicatesContent">
                                <p class="text-muted">No exact duplicates found.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Size Duplicates -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-file-earmark-diff"></i>
                                Size Duplicates (Same Size, Different Filename)
                                <span id="sizeDuplicatesCount" class="badge bg-warning ms-2">0</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="sizeDuplicatesContent">
                                <p class="text-muted">No size duplicates found.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="alert alert-danger" style="display: none;">
                    <h5>
                        <i class="bi bi-exclamation-triangle"></i>
                        Error
                    </h5>
                    <div id="errorContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            const scanForm = document.getElementById('scanForm');
            const testPathBtn = document.getElementById('testPathBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsSection = document.getElementById('resultsSection');
            const errorSection = document.getElementById('errorSection');

            // Load default values from config
            loadDefaults();

            // Handle form submission
            scanForm.addEventListener('submit', function(e) {
                e.preventDefault();
                startScan();
            });

            // Handle path testing
            testPathBtn.addEventListener('click', function() {
                testPath();
            });

            // Load default configuration values
            function loadDefaults() {
                const formData = new FormData();
                formData.append('action', 'get_defaults');

                fetch('index.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.defaults) {
                        // Set default remote drive path
                        if (data.defaults.remote_drive_path) {
                            document.getElementById('basePath').value = data.defaults.remote_drive_path;
                        }

                        // Set default paths to ignore
                        if (data.defaults.paths_to_ignore) {
                            document.getElementById('ignoredPaths').value = data.defaults.paths_to_ignore;
                        }
                    }
                })
                .catch(error => {
                    console.warn('Could not load defaults:', error.message);
                });
            }

            // Start duplicate scan
            function startScan() {
                showLoading();
                hideResults();
                hideError();

                const formData = new FormData(scanForm);
                formData.append('action', 'scan');

                fetch('index.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();

                    if (data.success) {
                        displayResults(data);
                    } else {
                        showError(data.error || 'Unknown error occurred');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showError('Network error: ' + error.message);
                });
            }

            // Test path accessibility
            function testPath() {
                const pathInput = document.getElementById('basePath');
                const testResult = document.getElementById('pathTestResult');
                const path = pathInput.value.trim();

                if (!path) {
                    testResult.innerHTML = '<div class="alert alert-warning">Please enter a path to test</div>';
                    return;
                }

                testResult.innerHTML = '<div class="text-info"><i class="bi bi-clock"></i> Testing path...</div>';

                const formData = new FormData();
                formData.append('action', 'test_path');
                formData.append('test_path', path);

                fetch('index.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayPathTestResult(data.result);
                    } else {
                        testResult.innerHTML = '<div class="alert alert-danger">Error testing path: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    testResult.innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
                });
            }

            // Display path test results
            function displayPathTestResult(result) {
                const testResult = document.getElementById('pathTestResult');
                let html = '<div class="alert ';

                if (result.exists && result.is_directory && result.is_readable) {
                    html += 'alert-success">';
                    html += '<i class="bi bi-check-circle"></i> Path is valid and accessible<br>';
                    if (result.file_count !== undefined) {
                        html += `<small>Found ${result.file_count} files and ${result.dir_count} directories</small>`;
                    }
                } else {
                    html += 'alert-warning">';
                    html += '<i class="bi bi-exclamation-triangle"></i> Path issues detected:<br>';
                    if (!result.exists) html += '• Path does not exist<br>';
                    if (!result.is_directory) html += '• Path is not a directory<br>';
                    if (!result.is_readable) html += '• Path is not readable<br>';
                }

                html += '</div>';
                testResult.innerHTML = html;
            }

            // Display scan results
            function displayResults(data) {
                displayStats(data.scan_stats, data.duplicates.stats, data.execution_time);
                displayExactDuplicates(data.duplicates.exact_duplicates);
                displaySizeDuplicates(data.duplicates.size_duplicates);
                showResults();
            }

            // Display statistics
            function displayStats(scanStats, duplicateStats, executionTime) {
                const statsContent = document.getElementById('statsContent');

                let html = '<div class="row">';
                html += '<div class="col-md-3"><strong>Total Files Found:</strong><br>' + scanStats.total_files + '</div>';
                html += '<div class="col-md-3"><strong>Total Size:</strong><br>' + formatFileSize(scanStats.total_size) + '</div>';
                html += '<div class="col-md-3"><strong>Exact Duplicates:</strong><br>' + duplicateStats.exact_duplicate_groups + ' groups</div>';
                html += '<div class="col-md-3"><strong>Size Duplicates:</strong><br>' + duplicateStats.size_duplicate_groups + ' groups</div>';
                html += '</div><hr>';
                html += '<div class="row">';
                html += '<div class="col-md-4"><strong>Wasted Space:</strong><br>' + duplicateStats.exact_duplicate_wasted_space_formatted + '</div>';
                html += '<div class="col-md-4"><strong>Potential Space:</strong><br>' + duplicateStats.size_duplicate_potential_space_formatted + '</div>';
                html += '<div class="col-md-4"><strong>Scan Time:</strong><br>' + executionTime + ' seconds</div>';
                html += '</div>';

                statsContent.innerHTML = html;
            }

            // Display exact duplicates
            function displayExactDuplicates(duplicates) {
                const content = document.getElementById('exactDuplicatesContent');
                const count = document.getElementById('exactDuplicatesCount');

                count.textContent = duplicates.length;

                if (duplicates.length === 0) {
                    content.innerHTML = '<p class="text-muted">No exact duplicates found.</p>';
                    return;
                }

                let html = '';
                duplicates.forEach((group, index) => {
                    html += '<div class="duplicate-group">';
                    html += '<div class="group-header">';
                    html += '<strong>' + escapeHtml(group.filename) + '</strong> ';
                    html += '<span class="badge bg-primary">' + group.filesize_formatted + '</span> ';
                    html += '<span class="badge bg-danger">' + group.count + ' copies</span>';
                    html += '</div>';

                    group.files.forEach(file => {
                        html += '<div class="mb-2 d-flex align-items-center">';
                        html += '<div class="flex-grow-1">';
                        html += '<a href="#" class="file-link" data-filepath="' + escapeHtml(file.filepath) + '">';
                        const isVideo = /\.(mp4|avi|mkv|mov|wmv|flv|webm)$/i.test(file.filepath);
                        if (isVideo) {
                            html += '<i class="bi bi-film"></i> Open in Celluloid';
                        } else {
                            html += '<i class="bi bi-image"></i> Open in Xviewer';
                        }
                        html += '</a>';
                        html += '<div class="file-path">' + escapeHtml(file.filepath) + '</div>';
                        html += '</div>';
                        html += '<button class="btn btn-outline-danger btn-sm ms-2 delete-file-btn" data-filepath="' + escapeHtml(file.filepath) + '" title="Delete file">';
                        html += '<i class="bi bi-trash"></i>';
                        html += '</button>';
                        html += '</div>';
                    });

                    html += '</div>';
                });

                content.innerHTML = html;

                // Attach click handlers to file links
                content.querySelectorAll('.file-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        openInXviewer(this.dataset.filepath);
                    });
                });

                // Attach click handlers to delete buttons
                content.querySelectorAll('.delete-file-btn').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        confirmAndDeleteFile(this.dataset.filepath, this);
                    });
                });
            }

            // Display size duplicates
            function displaySizeDuplicates(duplicates) {
                const content = document.getElementById('sizeDuplicatesContent');
                const count = document.getElementById('sizeDuplicatesCount');

                count.textContent = duplicates.length;

                if (duplicates.length === 0) {
                    content.innerHTML = '<p class="text-muted">No size duplicates found.</p>';
                    return;
                }

                let html = '';
                duplicates.forEach((group, index) => {
                    html += '<div class="size-duplicate-group">';
                    html += '<div class="group-header">';
                    html += '<strong>File Size: ' + group.filesize_formatted + '</strong> ';
                    html += '<span class="badge bg-warning">' + group.count + ' files</span> ';
                    html += '<span class="badge bg-info">' + group.unique_filenames + ' unique names</span>';
                    html += '</div>';

                    group.files.forEach(file => {
                        html += '<div class="mb-2 d-flex align-items-center">';
                        html += '<div class="flex-grow-1">';
                        html += '<a href="#" class="file-link" data-filepath="' + escapeHtml(file.filepath) + '">';
                        const isVideo = /\.(mp4|avi|mkv|mov|wmv|flv|webm)$/i.test(file.filepath);
                        if (isVideo) {
                            html += '<i class="bi bi-film"></i> ' + escapeHtml(file.filename);
                        } else {
                            html += '<i class="bi bi-image"></i> ' + escapeHtml(file.filename);
                        }
                        html += '</a>';
                        html += '<div class="file-path">' + escapeHtml(file.filepath) + '</div>';
                        html += '</div>';
                        html += '<button class="btn btn-outline-danger btn-sm ms-2 delete-file-btn" data-filepath="' + escapeHtml(file.filepath) + '" title="Delete file">';
                        html += '<i class="bi bi-trash"></i>';
                        html += '</button>';
                        html += '</div>';
                    });

                    html += '</div>';
                });

                content.innerHTML = html;

                // Attach click handlers to file links
                content.querySelectorAll('.file-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        openInXviewer(this.dataset.filepath);
                    });
                });

                // Attach click handlers to delete buttons
                content.querySelectorAll('.delete-file-btn').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        confirmAndDeleteFile(this.dataset.filepath, this);
                    });
                });
            }

            // Open file in appropriate viewer (Xviewer for images, Celluloid for videos)
            function openInXviewer(filepath) {
                const formData = new FormData();
                formData.append('action', 'open_file');
                formData.append('file_path', filepath);

                fetch('index.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Error opening file: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Network error: ' + error.message);
                });
            }

            // Utility functions
            function showLoading() {
                loadingIndicator.style.display = 'block';
            }

            function hideLoading() {
                loadingIndicator.style.display = 'none';
            }

            function showResults() {
                resultsSection.style.display = 'block';
            }

            function hideResults() {
                resultsSection.style.display = 'none';
            }

            function showError(message) {
                document.getElementById('errorContent').innerHTML = escapeHtml(message);
                errorSection.style.display = 'block';
            }

            function hideError() {
                errorSection.style.display = 'none';
            }

            function formatFileSize(bytes) {
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let size = bytes;
                let unitIndex = 0;

                while (size >= 1024 && unitIndex < units.length - 1) {
                    size /= 1024;
                    unitIndex++;
                }

                return Math.round(size * 100) / 100 + ' ' + units[unitIndex];
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Confirm and delete file
            function confirmAndDeleteFile(filepath, buttonElement) {
                // Show confirmation dialog
                const filename = filepath.split('/').pop();
                const confirmed = confirm(`Are you sure you want to delete this file?\n\n${filename}\n\nThis action cannot be undone.`);

                if (!confirmed) {
                    return;
                }

                // Disable the button and show loading state
                buttonElement.disabled = true;
                const originalHTML = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="bi bi-hourglass-split"></i>';

                const formData = new FormData();
                formData.append('action', 'delete_file');
                formData.append('file_path', filepath);

                fetch('index.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the file row from the display
                        const fileRow = buttonElement.closest('.mb-2, .d-flex');
                        const duplicateGroup = fileRow ? fileRow.closest('.duplicate-group, .size-duplicate-group') : null;

                        if (fileRow) {
                            fileRow.style.transition = 'opacity 0.3s';
                            fileRow.style.opacity = '0.5';
                            setTimeout(() => {
                                fileRow.remove();

                                // Check if only one file remains in the group
                                if (duplicateGroup) {
                                    const remainingFiles = duplicateGroup.querySelectorAll('.mb-2, .d-flex');
                                    if (remainingFiles.length === 1) {
                                        // Only one file left, fade out and hide the entire group
                                        duplicateGroup.style.transition = 'opacity 0.5s';
                                        duplicateGroup.style.opacity = '0';
                                        setTimeout(() => {
                                            duplicateGroup.remove();
                                        }, 500);
                                    }
                                }
                            }, 300);
                        }

                        // Show success message
                        showTemporaryMessage('File deleted successfully: ' + filename, 'success');
                    } else {
                        // Re-enable button and show error
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = originalHTML;
                        showTemporaryMessage('Error deleting file: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    // Re-enable button and show error
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = originalHTML;
                    showTemporaryMessage('Network error: ' + error.message, 'danger');
                });
            }

            // Show temporary message
            function showTemporaryMessage(message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alertDiv.style.top = '20px';
                alertDiv.style.right = '20px';
                alertDiv.style.zIndex = '9999';
                alertDiv.style.minWidth = '300px';

                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                document.body.appendChild(alertDiv);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>
